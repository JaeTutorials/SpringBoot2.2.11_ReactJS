<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="KimJeongKyun.toyShop.Router.UserDao">

    <select id="selectUserForLogin" parameterType="Map" resultType="Map">
        /* selectUserForLogin */
        SELECT *
          FROM TB_USER
         WHERE EMAIL = #{email}
           AND PASSWORD = #{password}
    </select>

    <insert id="insertSession" parameterType="Map">
        /* insertSession */
        INSERT INTO TB_SESSION (
            SESSION_ID
          , USER_ID
          , S_AUTH
          , SESSION_EXP
        ) VALUES (
            SESSION_SEQ.NEXTVAL
          , #{user_id}
          , #{s_auth}
          , SYSDATE + #{session_exp}/(24*60) -- session_exp 분 후 세션 파기
        )
    </insert>

    <select id="selectUserSession" parameterType="Map" resultType="Map">
        /* selectUserSession */
        SELECT A.USER_ID
             , A.EMAIL
             , A.LASTNAME
             , A.ROLE
             , A.FILE_ID
             , CASE WHEN (B.SESSION_EXP &lt; SYSDATE) THEN 1 ELSE 0 END AS TIME_OVER
                <!--
                    >  : &gt;
                    <  : &lt;
                    >= : &gt;=
                    <= : &lt;=
                -->
          FROM TB_USER A
          LEFT OUTER JOIN TB_SESSION B
            ON A.USER_ID = B.USER_ID
         WHERE B.S_AUTH = #{s_auth}
    </select>

    <select id="selectCart" parameterType="Map" resultType="Map"> <!-- 다중 레코드 반환하는 방법 ? -->
        /* selectCart */
        SELECT CART_ID
             , PRODUCT_ID
             , QUANTITY
          FROM TB_CART
         WHERE USER_ID = #{user_id}
    </select>


    <delete id="deleteSession" parameterType="Map">
        /* deleteSession */
        DELETE
          FROM TB_SESSION
         WHERE S_AUTH = #{s_auth}
            OR USER_ID = #{user_id}
<!--           AND SESSION_EXP &lt; SYSDATE-->
    </delete>

</mapper>
